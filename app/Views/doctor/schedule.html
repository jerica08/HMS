<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Schedule - HMS Doctor</title>
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .section-header { 
            display:flex; 
            align-items:center;
            gap:1rem; 
            margin-bottom:1.5rem; 
            padding-bottom:1rem; 
            border-bottom:1px solid #e2e8f0; 
        }
        .section-icon { 
            width:40px; 
            height:40px; 
            border-radius:8px; 
            background:#3b82f6; 
            display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.2rem; }
        .placeholder { background:#fff; border-radius:8px; padding:1.25rem; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
        .info { color:#64748b; }
        /* Calendar & list */
        .calendar-card { background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); padding:1rem; }
        .calendar-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
        .calendar-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:.5rem; }
        .calendar-day { background:#f8fafc; border-radius:8px; padding:.75rem; min-height:140px; display:flex; flex-direction:column; gap:.5rem; }
        .day-title { font-weight:600; color:#334155; display:flex; align-items:center; justify-content:space-between; }
        .shift-chip { background:#e0f2fe; color:#075985; border:1px solid #bae6fd; border-radius:6px; padding:.35rem .5rem; font-size:.85rem; display:flex; align-items:center; gap:.35rem; cursor:pointer; }
        .shift-chip.afternoon { background:#dcfce7; color:#166534; border-color:#bbf7d0; }
        .shift-chip.night { background:#ede9fe; color:#5b21b6; border-color:#ddd6fe; }
        .upcoming-card { background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); padding:1rem; }
        .upcoming-item { display:flex; justify-content:space-between; align-items:center; padding:.75rem 0; border-bottom:1px solid #f1f5f9; }
        .upcoming-item:last-child { border-bottom:0; }
        .badge { padding:.2rem .5rem; border-radius:9999px; font-size:.75rem; }
        .badge.morning { background:#e0f2fe; color:#075985; }
        .badge.afternoon { background:#dcfce7; color:#166534; }
        .badge.night { background:#ede9fe; color:#5b21b6; }
        /* Modals */
        .modal { display:none; position:fixed; inset:0; z-index:1000; background:rgba(15,23,42,.45); }
        .modal.show { display:flex; align-items:center; justify-content:center; }
        .modal-content { background:#fff; border-radius:10px; width:94%; max-width:720px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.15); }
        .modal-header { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid #e5e7eb; background:#f8f9ff; }
        .modal-body { padding:1rem 1.25rem; }
        .modal-footer { display:flex; justify-content:flex-end; gap:.5rem; padding:1rem 1.25rem; border-top:1px solid #e5e7eb; background:#fff; }
        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }
        .form-grid .full { grid-column:1 / -1; }
        .form-label { font-size:.9rem; color:#374151; margin-bottom:.25rem; display:block; font-weight:600; }
        .form-input, .form-select, .form-textarea { width:100%; border:1px solid #e5e7eb; border-radius:8px; padding:.6rem .75rem; font-size:.95rem; }
        .form-textarea { min-height:90px; }
        .mini { padding:.35rem .6rem; font-size:.85rem; }
    </style>
</head>
<body class="doctor">

<header class="header">
    <div class="header-content">
        <div class="logo">
            <h1><i class="fas fa-user-md"></i> Doctor</h1>
        </div>
        <div class="user-info">
            <div class="user-avatar">
                <?= strtoupper(substr(\App\Helpers\UserHelper::getDisplayName($currentUser ?? null), 0, 2)) ?>
            </div>
            <div>
                <div style="font-weight: 600;">
                    <?= \App\Helpers\UserHelper::getDisplayName($currentUser ?? null) ?>
                </div>
                <div style="font-size: 0.9rem;opacity:0.8">
                    <?= \App\Helpers\UserHelper::getDisplayRole($currentUser ?? null) ?>
                </div>
            </div>
            <a class="btn btn-secondary" href="<?= base_url('profile') ?>" style="margin-left:.5rem;">
                <i class="fas fa-user"></i> Profile
            </a>
            <button class="logout-btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </div>
</header>

<div class="main-container">
    <nav class="sidebar">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="<?= base_url('doctor/dashboard') ?>" class="nav-link">
                    <i class="fas fa-tachometer-alt nav-icon"></i>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="<?= base_url('doctor/patients') ?>" class="nav-link">
                    <i class="fas fa-users nav-icon"></i>
                    My Patients
                </a>
            </li>
            <li class="nav-item">
                <a href="<?= base_url('doctor/appointments') ?>" class="nav-link">
                    <i class="fas fa-calendar-alt nav-icon"></i>
                    Appointments
                </a>
            </li>
            <li class="nav-item">
                <a href="<?= base_url('doctor/prescriptions') ?>" class="nav-link">
                    <i class="fas fa-prescription-bottle nav-icon"></i>
                    Prescriptions
                </a>
            </li>
            <li class="nav-item">
                <a href="<?= base_url('doctor/lab-results') ?>" class="nav-link">
                    <i class="fas fa-flask nav-icon"></i>
                    Lab Results
                </a>
            </li>
            <li class="nav-item">
                <a href="<?= base_url('doctor/ehr') ?>" class="nav-link">
                    <i class="fas fa-file-medical nav-icon"></i>
                    Electronic Health Record
                </a>
            </li>
            <li class="nav-item">
                <a href="<?= base_url('doctor/my-schedule') ?>" class="nav-link active">
                    <i class="fas fa-clock nav-icon"></i>
                    My Schedule
                </a>
            </li>
        </ul>      
    </nav>

    <main class="content">
        <h1 class="page-title">My Schedule</h1>
        <div class="page-actions" style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <button class="btn btn-success" id="addAvailabilityBtn"><i class="fas fa-plus"></i> Add Shift</button>
        </div>

        <br>
        <!-- My Shifts List -->
        <div class="placeholder">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-calendar-check"></i></div>
                <div>
                    <div class="section-title">My Shifts</div>
                    <div class="info">View and edit your upcoming shifts</div>
                </div>
            </div>
            <div style="overflow:auto;">
                <table style="width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                    <thead>
                        <tr style="background:#f8fafc; color:#374151;">
                            <th style="text-align:left; padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;">Date</th>
                            <th style="text-align:left; padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;">Start</th>
                            <th style="text-align:left; padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;">End</th>
                            <th style="text-align:left; padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;">Type</th>
                            <th style="text-align:left; padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;">Department</th>
                            <th style="text-align:left; padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;">Notes</th>
                            <th style="text-align:left; padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="myShiftsBody">
                        <tr>
                            <td colspan="7" style="text-align:center; color:#6b7280; padding:1rem;">Loading shifts...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add/Update Shift Modal -->
        <div id="doctorShiftModal" class="modal" aria-hidden="true">
            <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="doctorShiftTitle">
                <div class="modal-header">
                    <div class="modal-title" id="doctorShiftTitle" style="font-weight:600; display:flex; align-items:center; gap:.5rem;">
                        <i class="fas fa-user-md" style="color:#4f46e5"></i>
                        <span id="doctorShiftMode">Add Shift</span>
                    </div>
                    <button type="button" class="btn btn-secondary mini" id="closeDoctorShiftBtn" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="doctorShiftForm" method="post" action="#">
                    <?= csrf_field() ?>
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="full">
                                <label for="doc_shift_date" class="form-label">Date</label>
                                <input type="date" id="doc_shift_date" name="shift_date" class="form-input" required>
                            </div>
                            <div>
                                <label for="doc_shift_type" class="form-label">Shift Type</label>
                                <select id="doc_shift_type" name="shift_type" class="form-select" required>
                                    <option value="morning">Morning (06:00 - 14:00)</option>
                                    <option value="afternoon">Afternoon (14:00 - 22:00)</option>
                                    <option value="night">Night (22:00 - 06:00)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label for="doc_start_time" class="form-label">Start Time</label>
                                <input type="time" id="doc_start_time" name="start_time" class="form-input" required>
                            </div>
                            <div>
                                <label for="doc_end_time" class="form-label">End Time</label>
                                <input type="time" id="doc_end_time" name="end_time" class="form-input" required>
                            </div>
                            <div>
                                <label for="doc_location" class="form-label">Department/Unit</label>
                                <input type="text" id="doc_location" name="location" class="form-input" placeholder="e.g., Emergency, Cardiology" required>
                            </div>
                            <div class="full">
                                <label for="doc_notes" class="form-label">Notes (optional)</label>
                                <textarea id="doc_notes" name="notes" rows="3" class="form-textarea" placeholder="Additional details..."></textarea>
                            </div>
                            <div class="full" style="display:flex;align-items:center;gap:.5rem;">
                                <input type="checkbox" id="doc_repeat_weekly" name="repeat_weekly" value="1">
                                <label for="doc_repeat_weekly" class="form-label" style="margin:0;">Repeat weekly</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelDoctorShiftBtn">Cancel</button>
                        <button type="submit" class="btn btn-success" id="saveDoctorShiftBtn">
                            <i class="fas fa-save"></i>
                            <span id="doctorShiftSubmitText">Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            const doctorShiftModal = document.getElementById('doctorShiftModal');
            const addShiftBtn = document.getElementById('addAvailabilityBtn');
            const closeDoctorShiftBtn = document.getElementById('closeDoctorShiftBtn');
            const cancelDoctorShiftBtn = document.getElementById('cancelDoctorShiftBtn');
            const doctorShiftForm = document.getElementById('doctorShiftForm');
            const doctorShiftMode = document.getElementById('doctorShiftMode');
            const doctorShiftSubmitText = document.getElementById('doctorShiftSubmitText');
            let currentEditShiftId = null;

            function openDoctorShiftModal(mode = 'add', shift = null) {
                doctorShiftModal.classList.add('show');
                doctorShiftModal.setAttribute('aria-hidden', 'false');
                doctorShiftMode.textContent = mode === 'edit' ? 'Update Shift' : 'Add Shift';
                doctorShiftSubmitText.textContent = mode === 'edit' ? 'Update' : 'Save';
                currentEditShiftId = null;

                // Prefill with today and default shift if adding
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                document.getElementById('doc_shift_date').value = `${yyyy}-${mm}-${dd}`;
                document.getElementById('doc_shift_type').value = 'morning';
                document.getElementById('doc_start_time').value = '06:00';
                document.getElementById('doc_end_time').value = '14:00';
                document.getElementById('doc_location').value = '';
                document.getElementById('doc_notes').value = '';
                document.getElementById('doc_repeat_weekly').checked = false;

                if (mode === 'edit' && shift) {
                    currentEditShiftId = shift.id;
                    document.getElementById('doc_shift_date').value = shift.date || '';
                    document.getElementById('doc_shift_type').value = (shift.shift_type || shift.type || 'morning');
                    document.getElementById('doc_start_time').value = shift.start_time || shift.start || '';
                    document.getElementById('doc_end_time').value = shift.end_time || shift.end || '';
                    document.getElementById('doc_location').value = shift.department || '';
                    document.getElementById('doc_notes').value = shift.notes || '';
                    document.getElementById('doc_repeat_weekly').checked = (Number(shift.repeat_weekly) === 1);
                }
            }

            function closeDoctorShiftModal() {
                doctorShiftModal.classList.remove('show');
                doctorShiftModal.setAttribute('aria-hidden', 'true');
            }

            addShiftBtn?.addEventListener('click', () => openDoctorShiftModal('add'));
            closeDoctorShiftBtn?.addEventListener('click', closeDoctorShiftModal);
            cancelDoctorShiftBtn?.addEventListener('click', closeDoctorShiftModal);
            doctorShiftModal?.addEventListener('click', (e) => { if (e.target === doctorShiftModal) closeDoctorShiftModal(); });

            // Sync default times to selected shift type (if not custom)
            const docShiftTypeSelect = document.getElementById('doc_shift_type');
            docShiftTypeSelect?.addEventListener('change', () => {
                const type = docShiftTypeSelect.value;
                const start = document.getElementById('doc_start_time');
                const end = document.getElementById('doc_end_time');
                if (type === 'morning') { start.value = '06:00'; end.value = '14:00'; }
                else if (type === 'afternoon') { start.value = '14:00'; end.value = '22:00'; }
                else if (type === 'night') { start.value = '22:00'; end.value = '06:00'; }
            });

            async function loadMyShifts() {
                const tbody = document.getElementById('myShiftsBody');
                try {
                    const res = await fetch('<?= base_url('doctor/mySchedule/shifts/api') ?>', { headers: { 'Accept': 'application/json' } });
                    const json = await res.json();
                    const rows = Array.isArray(json?.data) ? json.data : [];
                    if (rows.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#6b7280; padding:1rem;">No shifts yet.</td></tr>';
                        return;
                    }
                    // Keep a copy with IDs not present in API shape, so we re-fetch after create/update
                    tbody.innerHTML = rows.map((r, idx) => {
                        const typeBadge = r.type ? `<span class=\"badge ${r.type}\">${r.type}</span>` : '';
                        return `
                            <tr data-row="${idx}">
                                <td style=\"padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;\">${r.date ?? ''}</td>
                                <td style=\"padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;\">${r.start ?? ''}</td>
                                <td style=\"padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;\">${r.end ?? ''}</td>
                                <td style=\"padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;\">${typeBadge}</td>
                                <td style=\"padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;\">${r.department ?? ''}</td>
                                <td style=\"padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;\">${r.notes ?? ''}</td>
                                <td style=\"padding:.6rem .9rem; border-bottom:1px solid #e5e7eb;\">
                                    <button class=\"btn btn-primary btn-small\" data-action=\"edit\" data-index=\"${idx}\"><i class=\"fas fa-edit\"></i> Edit</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    // Attach edit handlers
                    tbody.querySelectorAll('button[data-action="edit"]').forEach((btn) => {
                        btn.addEventListener('click', () => {
                            const index = btn.getAttribute('data-index');
                            // r has no ID in doctor API; we cannot update without ID unless backend returns it.
                            // Enhancement: we can add a separate API to list with IDs for doctors or update shiftsApi to include ID.
                            // For now, open edit with available fields but disable submit if no ID.
                            const r = rows[index];
                            openDoctorShiftModal('edit', r);
                            if (!r.id) {
                                currentEditShiftId = null; // ensure create-only if no id
                            } else {
                                currentEditShiftId = r.id;
                            }
                        });
                    });
                } catch (e) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#ef4444; padding:1rem;">Failed to load shifts.</td></tr>';
                }
            }

            doctorShiftForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(doctorShiftForm);
                const isEdit = !!currentEditShiftId;
                try {
                    const url = isEdit
                        ? `<?= base_url('doctor/mySchedule/shifts') ?>/${currentEditShiftId}`
                        : `<?= base_url('doctor/mySchedule/shifts') ?>`;
                    const method = isEdit ? 'POST' : 'POST'; // using POST for both; update route accepts POST as fallback
                    const res = await fetch(url, {
                        method,
                        headers: { 'Accept': 'application/json' },
                        body: formData
                    });
                    const data = await res.json();
                    if (!res.ok || data?.status !== 'success') {
                        const msg = data?.message || 'Failed to save shift';
                        const errs = data?.errors ? ('\n' + JSON.stringify(data.errors)) : '';
                        alert(msg + errs);
                        return;
                    }
                    closeDoctorShiftModal();
                    await loadMyShifts();
                    alert(isEdit ? 'Shift updated successfully' : 'Shift created successfully');
                } catch (err) {
                    console.error(err);
                    alert('An error occurred while saving the shift');
                }
            });

            // Initial load
            window.addEventListener('DOMContentLoaded', () => {
                loadMyShifts();
            });
        </script>

        
    </main>
</div>

<script src="<?= base_url('js/logout.js') ?>"></script>
</body>
</html>
