const AnalyticsManager=function(){const e=document.querySelector('meta[name="base-url"]').getAttribute("content")||"/",t=document.querySelector('meta[name="csrf-token"]').getAttribute("content")||"",a=document.querySelector('meta[name="user-role"]').getAttribute("content")||"";let n={};function r(e){return document.getElementById(e)}function o(e){let t=new Date(e);const a=e=>String(e).padStart(2,"0");return t.getFullYear()+"-"+a(t.getMonth()+1)+"-"+a(t.getDate())}function i(){let e=r("dateRange"),t=e?e.value:"month",a=new Date,n=o(a),i;switch(t){case"today":i=n;break;case"week":i=o(new Date(a.getTime()-6*864e5));break;case"month":i=o(new Date(a.getTime()-29*864e5));break;case"quarter":i=o(new Date(a.getTime()-89*864e5));break;case"year":i=o(new Date(a.getTime()-364*864e5));break;case"custom":i=(null==r("startDate")?void 0:r("startDate").value)||n,n=(null==r("endDate")?void 0:r("endDate").value)||n;break;default:i=n}return{start:i,end:n}}async function l(){let t=i();try{let a=e.replace(/\/$/,"")+"/analytics/api?start_date="+encodeURIComponent(t.start)+"&end_date="+encodeURIComponent(t.end),n=await fetch(a,{headers:{Accept:"application/json"}}),r=await n.json();r&&r.success?(window.analyticsData=r.data||{},p(),showAnalyticsNotification("Data updated","success")):showAnalyticsNotification("Failed to load analytics","error")}catch(e){showAnalyticsNotification("Error loading analytics","error")}}function s(e,t){let a=r(e);a&&(n[e]&&n[e].destroy(),n[e]=new Chart(a,t))}function d(e){let t=(e.appointment_analytics||{}).daily_appointments||[];s("appointmentTrendsChart",{type:"line",data:{labels:t.map(e=>e.date),datasets:[{label:"Appointments",data:t.map(e=>Number(e.count)||0),borderColor:"#6366f1",backgroundColor:"rgba(99,102,241,0.2)",tension:.3,fill:!0}]},options:{responsive:!0,plugins:{legend:{display:!1}}}});let a=e.patient_analytics&&e.patient_analytics.patients_by_type||[];s("patientTypeChart",{type:"doughnut",data:{labels:a.map(e=>e.patient_type||"Unknown"),datasets:[{data:a.map(e=>Number(e.count)||0),backgroundColor:["#1d4ed8","#0ea5e9","#22c55e","#f59e0b","#ef4444","#8b5cf6"]}]},options:{responsive:!0}});let n=(e.appointment_analytics||{}).appointments_by_status||[];s("appointmentStatusChart",{type:"bar",data:{labels:n.map(e=>e.status||"Unknown"),datasets:[{label:"Count",data:n.map(e=>Number(e.count)||0),backgroundColor:"#a78bfa"}]},options:{responsive:!0,plugins:{legend:{display:!1}}}});let r=e.financial_analytics&&e.financial_analytics.revenue_by_month||[];s("revenueTrendChart",{type:"line",data:{labels:r.map(e=>e.month),datasets:[{label:"Revenue",data:r.map(e=>Number(e.revenue)||0),borderColor:"#10b981",backgroundColor:"rgba(16,185,129,0.2)",tension:.3,fill:!0}]},options:{responsive:!0,plugins:{legend:{display:!1}}}});let o=e.staff_analytics&&e.staff_analytics.staff_by_role||[];s("staffDistributionChart",{type:"pie",data:{labels:o.map(e=>e.role||"Unknown"),datasets:[{data:o.map(e=>Number(e.count)||0),backgroundColor:["#f59e0b","#3b82f6","#ef4444","#10b981","#8b5cf6","#06b6d4","#f472b6"]}]},options:{responsive:!0}})}function c(e){let t=e.my_appointments||{};s("doctorAppointmentsChart",{type:"bar",data:{labels:["Total","Completed"],datasets:[{label:"Appointments",data:[Number(t.total_appointments)||0,Number(t.completed_appointments)||0],backgroundColor:["#6366f1","#10b981"]}]},options:{responsive:!0,plugins:{legend:{display:!1}}}}),s("patientGrowthChart",{type:"line",data:{labels:["-5","-4","-3","-2","-1","Now"],datasets:[{label:"Patients",data:[0,0,0,0,0,e.my_patients&&Number(e.my_patients.total_patients)||0],borderColor:"#f59e0b",backgroundColor:"rgba(245,158,11,0.2)",tension:.3,fill:!0}]},options:{responsive:!0,plugins:{legend:{display:!1}}}})}function u(e){let t=r("activityTableBody");if(!t)return;t.innerHTML="";let a=[],n=new Date;a.push({date:o(n),type:"Patients",detail:"Total patients",status:e.patient_analytics&&e.patient_analytics.total_patients||0}),a.push({date:o(n),type:"Appointments",detail:"Total appointments",status:e.appointment_analytics&&e.appointment_analytics.total_appointments||0}),a.push({date:o(n),type:"Revenue",detail:"Total revenue",status:e.financial_analytics&&e.financial_analytics.total_revenue||0}),a.forEach(e=>{let a=document.createElement("tr");a.innerHTML="<td>"+e.date+"</td><td>"+e.type+"</td><td>"+e.detail+"</td><td>"+e.status+"</td>",t.appendChild(a)})}function p(){let e=window.analyticsData||{};"admin"===a||"accountant"===a||"it_staff"===a?(d(e),u(e)):"doctor"===a?c(e):("nurse"===a||"receptionist"===a)&&u(e)}function f(e,t){let a=document.createElement("a");a.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(t)),a.setAttribute("download",e),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)}async function y(){let e=window.analyticsData||{};f("analytics-"+Date.now()+".json",JSON.stringify(e))}async function g(){let a=r("reportModal"),n=r("reportType");if(!n||!n.value){showAnalyticsNotification("Select report type","error");return}let i=r("reportDateRange"),l,s;let d=new Date,c=o(d),u=i?i.value:"month";switch(u){case"week":l=o(new Date(d.getTime()-6*864e5));break;case"month":l=o(new Date(d.getTime()-29*864e5));break;case"quarter":l=o(new Date(d.getTime()-89*864e5));break;case"year":l=o(new Date(d.getTime()-364*864e5));break;default:l=c}let p={report_type:n.value,filters:{start_date:l,end_date:c}};try{let n=await fetch(e.replace(/\/$/,"")+"/analytics/report/generate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":t},body:JSON.stringify(p)}),r=await n.json();if(r&&r.success){showAnalyticsNotification("Report ready","success");let e="report-"+p.report_type+"-"+Date.now()+".json";r.report&&f(e,JSON.stringify(r.report)),a&&(a.style.display="none")}else showAnalyticsNotification("Failed to generate report","error")}catch(e){showAnalyticsNotification("Error generating report","error")}}function m(){let e=r("dateRange"),t=r("customDateGroup"),a=r("customDateGroup2");e&&e.addEventListener("change",function(){let n="custom"===this.value;t&&(t.style.display=n?"block":"none"),a&&(a.style.display=n?"block":"none")})}return document.addEventListener("DOMContentLoaded",function(){m(),p()}),{openReportModal:function(){let e=r("reportModal");e&&(e.style.display="block")},closeReportModal:function(){let e=r("reportModal");e&&(e.style.display="none")},applyFilters:l,refreshData:function(){l()},exportData:y,generateReport:g}}();
